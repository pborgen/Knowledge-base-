<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Knowledge Copilot</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 16px; }
    .card { background: #111827; border: 1px solid #334155; border-radius: 12px; padding: 14px; margin-bottom: 12px; }
    input, button, textarea, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #334155; background: #0b1220; color: #e2e8f0; }
    button { background: #1d4ed8; border: 0; font-weight: 600; margin-top: 8px; }
    pre { white-space: pre-wrap; font-size: 12px; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <h2>Personal Knowledge Copilot</h2>

    <div class="card">
      <h3>Account</h3>
      <input id="email" placeholder="your email (dev auth header)" />
      <button onclick="loadSpaces()">Load spaces</button>
      <select id="space"></select>
      <input id="newSpace" placeholder="new space name" />
      <select id="spaceVisibility"><option>private</option><option>shared</option><option>public</option></select>
      <button onclick="createSpace()">Create space</button>
      <input id="shareEmail" placeholder="share with email" />
      <button onclick="shareSpace()">Share selected space</button>
    </div>

    <div class="card">
      <h3>Upload file</h3>
      <input id="file" type="file" />
      <button onclick="uploadFile()">Upload & Ingest</button>
    </div>

    <div class="card">
      <h3>Google Docs ingest</h3>
      <input id="docUrl" placeholder="https://docs.google.com/document/d/..." />
      <input id="googleClientId" placeholder="Google OAuth Client ID" />
      <button onclick="googleLogin()">Sign in + Ingest Google Doc</button>
      <small id="gstatus"></small>
    </div>

    <div class="card">
      <h3>Ask your knowledge base</h3>
      <textarea id="q" rows="4" placeholder="Ask a question..."></textarea>
      <button onclick="ask()">Ask</button>
      <pre id="out"></pre>
    </div>
  </div>

  <script>
    function authHeaders() {
      return { 'x-user-email': document.getElementById('email').value.trim() };
    }
    function selectedSpace() {
      return document.getElementById('space').value;
    }

    async function loadSpaces() {
      const r = await fetch('/api/spaces', { headers: authHeaders() });
      const j = await r.json();
      const sel = document.getElementById('space'); sel.innerHTML = '';
      (j.spaces || []).forEach(s => {
        const o = document.createElement('option');
        o.value = s.id; o.textContent = `${s.name} (${s.visibility})`; sel.appendChild(o);
      });
    }

    async function createSpace() {
      await fetch('/api/spaces', {
        method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: document.getElementById('newSpace').value, visibility: document.getElementById('spaceVisibility').value })
      });
      await loadSpaces();
    }

    async function shareSpace() {
      const id = selectedSpace();
      if (!id) return;
      await fetch(`/api/spaces/${id}/share`, {
        method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ targetEmail: document.getElementById('shareEmail').value })
      });
      await loadSpaces();
    }

    async function uploadFile() {
      const f = document.getElementById('file').files[0];
      if (!f) return alert('Choose a file first');
      const fd = new FormData();
      fd.append('file', f);
      fd.append('spaceId', selectedSpace());
      const r = await fetch('/api/ingest/upload', { method: 'POST', body: fd, headers: authHeaders() });
      const j = await r.json();
      alert(j.ok ? 'Uploaded + ingested' : j.error || 'Failed');
    }

    async function googleLogin() {
      const clientId = document.getElementById('googleClientId').value.trim();
      const docUrl = document.getElementById('docUrl').value.trim();
      if (!clientId || !docUrl) return alert('Need Google Client ID and Doc URL');

      google.accounts.id.initialize({ client_id: clientId, callback: async (resp) => {
          const idToken = resp.credential;
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: clientId,
            scope: 'https://www.googleapis.com/auth/documents.readonly openid email profile',
            callback: async (tokenResp) => {
              const accessToken = tokenResp.access_token;
              const r = await fetch('/api/ingest/google-doc', {
                method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken, accessToken, docUrl, spaceId: selectedSpace() })
              });
              const j = await r.json();
              document.getElementById('gstatus').textContent = j.ok ? 'Google Doc ingested âœ…' : (j.error || 'Failed');
            }
          });
          tokenClient.requestAccessToken();
        }
      });
      google.accounts.id.prompt();
    }

    async function ask() {
      const question = document.getElementById('q').value;
      const r = await fetch('/api/answer', {
        method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, topK: 8, filters: { spaceId: selectedSpace() } })
      });
      const j = await r.json();
      document.getElementById('out').textContent = j.answer || j.error || 'No answer';
    }
  </script>
</body>
</html>
